---
# Quick fix playbook to update GOAD inventory files with correct become method
# This fixes the "powershell shell family is incompatible with sudo" error

- name: Fix Windows become method in GOAD inventory
  hosts: deployment_boxes
  gather_facts: false
  become: true

  tasks:
    - name: Update GOAD inventory file with runas become method
      copy:
        dest: /opt/goad/ad/GOAD/providers/proxmox/inventory
        content: |
          [default]
          ; GOAD inventory for pre-provisioned infrastructure
          ; IPs are internal to the isolated network (192.168.56.0/24)
          ; ------------------------------------------------
          ; sevenkingdoms.local
          ; ------------------------------------------------
          dc01 ansible_host=192.168.56.10 dns_domain=dc01 dict_key=dc01
          ; ------------------------------------------------
          ; north.sevenkingdoms.local
          ; ------------------------------------------------
          dc02 ansible_host=192.168.56.11 dns_domain=dc01 dict_key=dc02
          srv02 ansible_host=192.168.56.22 dns_domain=dc02 dict_key=srv02
          ; ------------------------------------------------
          ; essos.local
          ; ------------------------------------------------
          dc03 ansible_host=192.168.56.12 dns_domain=dc03 dict_key=dc03
          srv03 ansible_host=192.168.56.23 dns_domain=dc03 dict_key=srv03

          [all:vars]
          force_dns_server=false
          ansible_user=cyberrange
          ansible_password=Cyberrange123!
          ansible_connection=winrm
          ansible_winrm_server_cert_validation=ignore
          ansible_winrm_transport=ntlm
          ansible_port=5985
          ansible_become_method=runas
          ansible_become_user=cyberrange
        mode: '0644'

    - name: Verify inventory file was updated
      command: grep -q "ansible_become_method=runas" /opt/goad/ad/GOAD/providers/proxmox/inventory
      changed_when: false

    - name: Display success message
      debug:
        msg: "GOAD inventory updated with runas become method for Windows hosts"
